name: Build and Push Docker Image

on:
  release:
    types:
      - published  # å½“é€šè¿‡ GitHub Releases é¡µé¢åˆ›å»º release æ—¶è§¦å‘
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: true
        type: choice
        options:
          - package-only        # åªæ‰“åŒ…äº§ç‰©
          - package-and-docker # æ‰“åŒ…äº§ç‰© + Docker é•œåƒ
        default: 'package-and-docker'
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆä¾‹å¦‚: v1.0.0ï¼‰'
        required: false
        type: string
      tag_name:
        description: 'Git Tag åç§°ï¼ˆç•™ç©ºåˆ™ä½¿ç”¨ versionï¼‰'
        required: false
        type: string

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # éœ€è¦å†™æƒé™ä»¥ä¸Šä¼  Assets
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name || github.event.inputs.tag_name || github.event.inputs.version || github.ref }}
      
      - name: Determine build type
        id: build_config
        run: |
          # ç¡®å®šæ„å»ºç±»å‹
          if [ "${{ github.event_name }}" = "release" ]; then
            # Release äº‹ä»¶ï¼šé»˜è®¤åªæ‰“åŒ…äº§ç‰©ï¼ˆä¸æ„å»º Dockerï¼‰
            BUILD_TYPE="package-only"
            echo "ğŸ“¦ Release äº‹ä»¶ï¼šå°†åªæ‰“åŒ…äº§ç‰©ï¼ˆä¸æ„å»º Dockerï¼‰"
          else
            # workflow_dispatch äº‹ä»¶ï¼šä½¿ç”¨ç”¨æˆ·è¾“å…¥
            BUILD_TYPE="${{ github.event.inputs.build_type }}"
            echo "ğŸ”§ æ‰‹åŠ¨è§¦å‘ï¼šæ„å»ºç±»å‹ = ${BUILD_TYPE}"
          fi
          
          echo "BUILD_TYPE=${BUILD_TYPE}" >> $GITHUB_OUTPUT
      
      - name: Extract version and check if pre-release
        id: extract_version
        run: |
          # ä»ä¸åŒäº‹ä»¶æºæå–ç‰ˆæœ¬å·
          if [ "${{ github.event_name }}" = "release" ]; then
            # Release äº‹ä»¶ï¼šä» release tag ä¸­æå–
            TAG_NAME="${{ github.event.release.tag_name }}"
            IS_PRERELEASE="${{ github.event.release.prerelease }}"
          else
            # workflow_dispatch äº‹ä»¶ï¼šä»è¾“å…¥å‚æ•°ä¸­æå–
            TAG_NAME="${{ github.event.inputs.tag_name }}"
            if [ -z "$TAG_NAME" ]; then
              TAG_NAME="${{ github.event.inputs.version }}"
            fi
            # å¦‚æœä»ç„¶ä¸ºç©ºï¼Œå°è¯•ä» git ref ä¸­æå–
            if [ -z "$TAG_NAME" ]; then
              TAG_NAME=${GITHUB_REF#refs/tags/}
              if [ "$TAG_NAME" = "$GITHUB_REF" ]; then
                # ä¸æ˜¯ tagï¼Œå°è¯•ä»åˆ†æ”¯åæˆ– commit SHA è·å–
                TAG_NAME=${GITHUB_REF#refs/heads/}
                if [ "$TAG_NAME" = "$GITHUB_REF" ]; then
                  TAG_NAME="dev-$(date +%Y%m%d-%H%M%S)"
                  echo "âš ï¸  æœªæŒ‡å®šç‰ˆæœ¬å·ï¼Œä½¿ç”¨ä¸´æ—¶ç‰ˆæœ¬: $TAG_NAME"
                fi
              fi
            fi
            IS_PRERELEASE="false"
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼ï¼švæ•°å­—.æ•°å­—.æ•°å­—[-åç¼€]ï¼ˆä¾‹å¦‚ v1.0.0, v2.10.102, v1.0.0-betaï¼‰
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]] && [[ ! "$TAG_NAME" =~ ^dev- ]]; then
            echo "âš ï¸  è­¦å‘Š: ç‰ˆæœ¬å·æ ¼å¼ä¸ç¬¦åˆæ ‡å‡†ï¼Œä½†ä»å°†ç»§ç»­æ„å»º"
            echo "   å½“å‰ç‰ˆæœ¬å·: $TAG_NAME"
            echo "   æ ‡å‡†æ ¼å¼åº”ä¸º: væ•°å­—.æ•°å­—.æ•°å­— æˆ– væ•°å­—.æ•°å­—.æ•°å­—-åç¼€ (ä¾‹å¦‚: v1.0.0, v1.0.0-beta)"
          fi
          
          VERSION=${TAG_NAME#v}  # ç§»é™¤ v å‰ç¼€ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "TAG=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "ğŸ“‹ è¿™æ˜¯ Pre-release: $TAG_NAME"
          else
            echo "ğŸ“¦ è¿™æ˜¯æ­£å¼ç‰ˆæœ¬: $TAG_NAME"
          fi
      
      - name: Send Telegram notification (build started)
        if: steps.extract_version.outputs.IS_PRERELEASE == 'false' && steps.build_config.outputs.BUILD_TYPE == 'package-and-docker'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸  Telegram Bot Token æˆ– Chat ID æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # è·å–æ„å»ºä¿¡æ¯
          TAG="${{ steps.extract_version.outputs.TAG }}"
          
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_URL="${{ github.event.release.html_url }}"
            MESSAGE="ğŸ”¨ <b>Release æ„å»ºä¸­</b>"$'\n'$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”§ <b>æ„å»ºç±»å‹:</b> Docker å‡çº§"$'\n'"ğŸ”— <a href=\"${RELEASE_URL}\">æŸ¥çœ‹ Release</a>"
          else
            WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            MESSAGE="ğŸ”¨ <b>æ„å»ºä¸­</b>"$'\n'$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”§ <b>æ„å»ºç±»å‹:</b> Docker å‡çº§"$'\n'"ğŸ”— <a href=\"${WORKFLOW_URL}\">æŸ¥çœ‹ Workflow</a>"
          fi
          
          # å‘é€ Telegram æ¶ˆæ¯ï¼ˆä½¿ç”¨ jq è½¬ä¹‰ JSONï¼‰
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')" > /tmp/telegram_response.json
          
          # æ£€æŸ¥å‘é€ç»“æœ
          if [ $? -eq 0 ]; then
            RESPONSE=$(cat /tmp/telegram_response.json)
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: $RESPONSE"
              # é€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
              exit 0
            fi
          else
            echo "âŒ å‘é€ Telegram æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯"
            # é€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
            exit 0
          fi
      
      # ============ ç¼–è¯‘å‰åç«¯äº§ç‰© ============
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Build Backend JAR
        run: |
          cd backend
          chmod +x gradlew
          ./gradlew bootJar --no-daemon
          echo "âœ… åç«¯æ„å»ºå®Œæˆ"
          ls -lh build/libs/*.jar
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Build Frontend
        env:
          VERSION: ${{ steps.extract_version.outputs.VERSION }}
          GIT_TAG: ${{ steps.extract_version.outputs.TAG }}
          GITHUB_REPO_URL: https://github.com/WrBug/PolyHermes
        run: |
          cd frontend
          npm ci
          npm run build
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
          echo "ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯: VERSION=${{ steps.extract_version.outputs.VERSION }}, GIT_TAG=${{ steps.extract_version.outputs.TAG }}"
          du -sh dist/
      
      # ============ æ‰“åŒ…æ›´æ–°åŒ… ============
      - name: Create Update Package
        run: |
          echo "ğŸ“¦ å¼€å§‹æ‰“åŒ…æ›´æ–°åŒ…..."
          
          # åˆ›å»ºç›®å½•ç»“æ„
          mkdir -p update-package/backend
          mkdir -p update-package/frontend
          
          # å¤åˆ¶åç«¯ JAR
          cp backend/build/libs/*.jar update-package/backend/polyhermes.jar
          echo "âœ… åç«¯ JAR å·²å¤åˆ¶"
          
          # å¤åˆ¶å‰ç«¯äº§ç‰©
          cp -r frontend/dist/* update-package/frontend/
          echo "âœ… å‰ç«¯æ–‡ä»¶å·²å¤åˆ¶"
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_NOTES=$(echo '${{ github.event.release.body }}' | jq -Rs .)
          else
            RELEASE_NOTES="\"æ‰‹åŠ¨æ„å»º - workflow_dispatch\""
          fi
          
          cat > update-package/version.json <<EOF
          {
            "version": "${{ steps.extract_version.outputs.VERSION }}",
            "tag": "${{ steps.extract_version.outputs.TAG }}",
            "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "releaseNotes": ${RELEASE_NOTES}
          }
          EOF
          echo "âœ… ç‰ˆæœ¬ä¿¡æ¯å·²åˆ›å»º"
          
          # æ‰“åŒ…æˆ tar.gz
          cd update-package
          tar -czf ../polyhermes-${{ steps.extract_version.outputs.TAG }}-update.tar.gz .
          cd ..
          
          echo "âœ… æ‰“åŒ…å®Œæˆ: polyhermes-${{ steps.extract_version.outputs.TAG }}-update.tar.gz"
          ls -lh polyhermes-*.tar.gz
      
      - name: Calculate Checksum
        id: checksum
        run: |
          FILE="polyhermes-${{ steps.extract_version.outputs.TAG }}-update.tar.gz"
          CHECKSUM=$(sha256sum "$FILE" | awk '{print $1}')
          echo "CHECKSUM=$CHECKSUM" >> $GITHUB_OUTPUT
          echo "âœ… SHA256: $CHECKSUM"
          echo "$CHECKSUM  $FILE" > checksums.txt
      
      - name: Upload Update Package to Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./polyhermes-${{ steps.extract_version.outputs.TAG }}-update.tar.gz
          asset_name: polyhermes-${{ steps.extract_version.outputs.TAG }}-update.tar.gz
          asset_content_type: application/gzip
      
      - name: Upload Checksums to Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./checksums.txt
          asset_name: checksums.txt
          asset_content_type: text/plain
      
      - name: Upload Update Package as Artifact
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: polyhermes-${{ steps.extract_version.outputs.TAG }}-update
          path: |
            polyhermes-${{ steps.extract_version.outputs.TAG }}-update.tar.gz
            checksums.txt
          retention-days: 30
      
      - name: Set up Docker Buildx
        if: steps.build_config.outputs.BUILD_TYPE == 'package-and-docker'
        uses: docker/setup-buildx-action@v3
        with:
          # å¯ç”¨å¤šæ¶æ„æ„å»ºæ”¯æŒ
          platforms: linux/amd64,linux/arm64
      
      - name: Log in to Docker Hub
        if: steps.build_config.outputs.BUILD_TYPE == 'package-and-docker'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      
      - name: Prepare Docker build context
        if: steps.build_config.outputs.BUILD_TYPE == 'package-and-docker'
        run: |
          echo "ğŸ“¦ å‡†å¤‡ Docker æ„å»ºä¸Šä¸‹æ–‡..."
          # ç¡®ä¿æ„å»ºäº§ç‰©å­˜åœ¨ä¸”å¯è®¿é—®
          if [ ! -d "frontend/dist" ]; then
            echo "âŒ é”™è¯¯ï¼šfrontend/dist ä¸å­˜åœ¨"
            exit 1
          fi
          if [ ! -d "backend/build/libs" ] || [ -z "$(ls -A backend/build/libs/*.jar 2>/dev/null)" ]; then
            echo "âŒ é”™è¯¯ï¼šbackend/build/libs/*.jar ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… æ„å»ºäº§ç‰©å·²å‡†å¤‡å¥½"
          ls -lh frontend/dist/ | head -5
          ls -lh backend/build/libs/*.jar
      
      - name: Build and push Docker image
        if: steps.build_config.outputs.BUILD_TYPE == 'package-and-docker'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          # å¤šæ¶æ„æ„å»ºï¼šæ”¯æŒ amd64 å’Œ arm64
          platforms: linux/amd64,linux/arm64
          tags: |
            wrbug/polyhermes:${{ steps.extract_version.outputs.TAG }}
            ${{ steps.extract_version.outputs.IS_PRERELEASE == 'false' && 'wrbug/polyhermes:latest' || '' }}
          build-args: |
            BUILD_IN_DOCKER=false
            VERSION=${{ steps.extract_version.outputs.VERSION }}
            GIT_TAG=${{ steps.extract_version.outputs.TAG }}
            GITHUB_REPO_URL=https://github.com/WrBug/PolyHermes
          cache-from: type=registry,ref=wrbug/polyhermes:latest
          cache-to: type=inline
      
      - name: Skip Docker build notice
        if: steps.build_config.outputs.BUILD_TYPE == 'package-only'
        run: |
          echo "â­ï¸  è·³è¿‡ Docker é•œåƒæ„å»ºï¼ˆæ„å»ºç±»å‹ï¼špackage-onlyï¼‰"
          echo "âœ… ä»…æ‰“åŒ…äº§ç‰©å·²å®Œæˆ"

      - name: Send Telegram notification
        if: steps.extract_version.outputs.IS_PRERELEASE == 'false'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # æ£€æŸ¥å¿…è¦çš„ç¯å¢ƒå˜é‡
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "âš ï¸  Telegram Bot Token æˆ– Chat ID æœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥"
            exit 0
          fi
          
          # è·å–æ„å»ºä¿¡æ¯
          VERSION="${{ steps.extract_version.outputs.VERSION }}"
          TAG="${{ steps.extract_version.outputs.TAG }}"
          BUILD_TYPE="${{ steps.build_config.outputs.BUILD_TYPE }}"
          
          # æ„å»ºæ¶ˆæ¯å†…å®¹ï¼ˆä»…åŒ…å«å…³é”®ä¿¡æ¯ï¼‰
          DEPLOY_DOC_URL="https://github.com/WrBug/PolyHermes/blob/main/docs/zh/DEPLOYMENT.md"
          
          if [ "${{ github.event_name }}" = "release" ]; then
            RELEASE_URL="${{ github.event.release.html_url }}"
            if [ "$BUILD_TYPE" = "package-and-docker" ]; then
              MESSAGE="âœ… <b>Release æ„å»ºæˆåŠŸ</b>"$'\n'$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”§ <b>æ„å»ºç±»å‹:</b> Docker å‡çº§"$'\n'"ğŸ”— <a href=\"${RELEASE_URL}\">æŸ¥çœ‹ Release</a>"$'\n'"ğŸ“š <a href=\"${DEPLOY_DOC_URL}\">Docker éƒ¨ç½²æ–‡æ¡£</a>"
            else
              MESSAGE="âœ… <b>Release æ‰“åŒ…æˆåŠŸ</b>"$'\n'$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”§ <b>æ„å»ºç±»å‹:</b> åœ¨çº¿å‡çº§"$'\n'"ğŸ”— <a href=\"${RELEASE_URL}\">æŸ¥çœ‹ Release</a>"$'\n'"ğŸ“ <b>å‡çº§è·¯å¾„:</b> ç³»ç»Ÿç®¡ç† â†’ æ¦‚è§ˆ â†’ æ£€æŸ¥æ›´æ–°"
            fi
          else
            WORKFLOW_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            if [ "$BUILD_TYPE" = "package-and-docker" ]; then
              MESSAGE="âœ… <b>æ„å»ºæˆåŠŸ</b>"$'\n'$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”§ <b>æ„å»ºç±»å‹:</b> Docker å‡çº§"$'\n'"ğŸ”— <a href=\"${WORKFLOW_URL}\">æŸ¥çœ‹ Workflow</a>"$'\n'"ğŸ“š <a href=\"${DEPLOY_DOC_URL}\">Docker éƒ¨ç½²æ–‡æ¡£</a>"
            else
              MESSAGE="âœ… <b>æ‰“åŒ…æˆåŠŸ</b>"$'\n'$'\n'"ğŸ·ï¸ <b>Tag:</b> <code>${TAG}</code>"$'\n'"ğŸ”§ <b>æ„å»ºç±»å‹:</b> åœ¨çº¿å‡çº§"$'\n'"ğŸ”— <a href=\"${WORKFLOW_URL}\">æŸ¥çœ‹ Workflow</a>"$'\n'"ğŸ“ <b>å‡çº§è·¯å¾„:</b> ç³»ç»Ÿç®¡ç† â†’ æ¦‚è§ˆ â†’ æ£€æŸ¥æ›´æ–°"
            fi
          fi
          
          # å‘é€ Telegram æ¶ˆæ¯ï¼ˆä½¿ç”¨ jq è½¬ä¹‰ JSONï¼‰
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML", disable_web_page_preview: false}')" > /tmp/telegram_response.json
          
          # æ£€æŸ¥å‘é€ç»“æœ
          if [ $? -eq 0 ]; then
            RESPONSE=$(cat /tmp/telegram_response.json)
            if echo "$RESPONSE" | grep -q '"ok":true'; then
              echo "âœ… Telegram é€šçŸ¥å‘é€æˆåŠŸ"
            else
              echo "âŒ Telegram é€šçŸ¥å‘é€å¤±è´¥: $RESPONSE"
              # æ„å»ºæˆåŠŸï¼Œé€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
              exit 0
            fi
          else
            echo "âŒ å‘é€ Telegram æ¶ˆæ¯æ—¶å‘ç”Ÿé”™è¯¯"
            # æ„å»ºæˆåŠŸï¼Œé€šçŸ¥å¤±è´¥ä¸åº”è¯¥å¯¼è‡´æ•´ä¸ª job å¤±è´¥
            exit 0
          fi